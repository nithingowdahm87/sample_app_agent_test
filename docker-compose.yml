networks:
  backend-net:
    driver: bridge
  frontend-net:
    driver: bridge
services:
  backend:
    build: ./backend
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    environment:
    - DATABASE_URL=postgres://user:password@postgres:5432/database
    - REDIS_URL=redis://redis:6379
    healthcheck:
      interval: 10s
      retries: 5
      test:
      - curl
      - -f
      - http://localhost:3000/healthcheck
      timeout: 5s
    networks:
    - backend-net
    ports:
    - 3000:3000
  frontend:
    build: ./frontend
    depends_on:
      backend:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    environment:
    - BACKEND_URL=http://backend:3000
    healthcheck:
      interval: 10s
      retries: 5
      test:
      - curl
      - -f
      - http://localhost:5173/healthcheck
      timeout: 5s
    networks:
    - frontend-net
    ports:
    - 5173:5173
  nginx:
    depends_on:
    - frontend
    - backend
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    image: nginx:latest
    networks:
    - frontend-net
    - backend-net
    ports:
    - 80:80
    volumes:
    - ./nginx.conf:/etc/nginx/nginx.conf:ro
  postgres:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    environment:
    - POSTGRES_USER=user
    - POSTGRES_PASSWORD=password
    - POSTGRES_DB=database
    healthcheck:
      interval: 10s
      retries: 5
      test:
      - curl
      - -f
      - http://localhost:5432/healthcheck
      timeout: 5s
    image: postgres:13
    networks:
    - backend-net
    volumes:
    - postgres-data:/var/lib/postgresql/data
  redis:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      interval: 10s
      retries: 5
      test:
      - redis-cli
      - ping
      timeout: 5s
    image: redis:6
    networks:
    - backend-net
    volumes:
    - redis-data:/data
version: '3.8'
volumes:
  postgres-data: null
  redis-data: null
