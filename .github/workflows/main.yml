name: EKS Deployment Pipeline
true:
  push:
    branches:
    - main
jobs:
  compile:
    permissions:
      contents: read
      id-token: write
      security-events: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Compile
      run: '# Compile code here

        echo "Compilation successful"

        '
  docker-build:
    needs:
    - owasp-zap
    permissions:
      contents: read
      id-token: write
      security-events: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        password: ${{ secrets.DOCKER_PASSWORD }}
        username: ${{ secrets.DOCKER_USERNAME }}
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        provenance: false
        push: true
        tags: myapp:sha-${{ github.sha }}
  notify:
    if: always()
    needs:
    - trivy-image
    permissions:
      contents: read
      id-token: write
      security-events: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Send Slack notification
      uses: 8398a7/action-slack@v3
      with:
        branch: ${{ github.ref_name }}
        channel: my-channel
        repo: ${{ github.repository }}
        sha: ${{ github.sha }}
        slack-token: ${{ secrets.SLACK_TOKEN }}
        status: ${{ job.status }}
    - name: Send email notification
      uses: dawidd6/action-send-mail@v6
      with:
        body: 'Repository: ${{ github.repository }}

          Branch: ${{ github.ref_name }}

          SHA: ${{ github.sha }}

          Status: ${{ job.status }}

          '
        password: ${{ secrets.EMAIL_PASSWORD }}
        server-address: ${{ secrets.EMAIL_SERVER }}
        server-port: ${{ secrets.EMAIL_PORT }}
        subject: ${{ github.workflow }} - ${{ job.status }}
        to: ${{ secrets.EMAIL_TO }}
        username: ${{ secrets.EMAIL_USERNAME }}
  owasp-zap:
    needs:
    - sonar
    permissions:
      contents: read
      id-token: write
      security-events: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: OWASP ZAP scan
      uses: zaproxy/action-zap@v0.2.1
  secrets-scan:
    needs:
    - compile
    permissions:
      contents: read
      id-token: write
      security-events: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Gitleaks scan
      uses: gitleaks/gitleaks-action@v2
  sonar:
    needs:
    - trivy-fs
    permissions:
      contents: read
      id-token: write
      security-events: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: SonarQube analysis
      uses: sonarcloud/sonarcloud-github-action@v1.12.0
  trivy-fs:
    needs:
    - secrets-scan
    permissions:
      contents: read
      id-token: write
      security-events: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Trivy file system scan
      uses: aquasecurity/trivy-action@v0.25.1
  trivy-image:
    needs:
    - docker-build
    permissions:
      contents: read
      id-token: write
      security-events: write
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Trivy image scan
      uses: aquasecurity/trivy-action@v0.25.1
